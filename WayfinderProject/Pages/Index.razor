@page "/"
@inject WayfinderProjectAPI.Data.WayfinderContext context
@inject NavigationManager NavigationManager

@inject IJSRuntime JS
@inject IToastService toastService


@using Microsoft.EntityFrameworkCore
@using WayfinderProjectAPI.Data.DTOs
@using WayfinderProjectAPI.Controllers

<PageTitle>The Wayfinder Project</PageTitle>

<br/>
<br/>

<div class="wayfinder-background">
    <div class="row">
        <div class="col-md-6" style="align-self: center;">
            <div class="wayfinder-title">
                <img src="/images/wayfinder_project_title.png" style="float: left;" />
            </div>
        </div>

        <div class="col-md-6" style="align-self: center;">
            <div class="wayfinder-description">
                <span style="text-align: end;">Kingdom Hearts Resource Database</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="ma-folder">
            <span class="folder-title">Memory Archive</span>

            <div class="folder-container">
                <div class="folder-redirect">
                    <span class="oi oi-chevron-right" style="color: white"></span>
                </div>

                <div class="folder-image" onclick="@(() => NavigationManager.NavigateTo("/memory_archive", true))">
                    <img src="/images/WFP_logo.png" style="width: 40vh;" />
                </div>
            </div>

            <div class="folder-content">
                Scour the Memory Archives to find scenes using criteria such as characters or worlds, enjoy the Cutscene of the day 
                or let us decide for you by selecting a Random Cutscene.
            </div>
        </div>
    </div>

    @*<div class="col-md-4">
        <div class="jj-folder">
            <span class="folder-title">Coming Soon</span>

            <div class="folder-container">
                <div class="folder-redirect">
                    <span class="oi oi-chevron-right" style="color: white"></span>
                </div>

                <div class="folder-image" onclick="@(() => NavigationManager.NavigateTo("/-------", true))">
                    <img src="/images/jj_logo.png" style="width: 40vh;" />
                </div>
            </div>

            <div class="folder-content">
                Coming Soon.
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="ms-folder">
            <span class="folder-title">Coming Soon</span>

            <div class="folder-container">
                <div class="folder-redirect">
                    <span class="oi oi-chevron-right" style="color: white"></span>
                </div>

                <div class="folder-image" onclick="@(() => NavigationManager.NavigateTo("/--------", true))">
                    <img src="/images/--_logo.png" style="width: 40vh;" />
                </div>
            </div>

            <div class="folder-content">
                Coming Soon.
            </div>
        </div>
    </div>*@
</div>


<style>
.clickable {
    float: right; 
    font-size: 1rem; 
    color: #3e79a7; 
    margin-top: 3px; 
    cursor: pointer;
}

.icon {
    font-size: .8rem;
    width: 20px;
    height: 20px;
    border: 1px solid black;
    padding: 4px 5px;
    border-radius: 500px;
    background-color: #bee2ff;
}
</style>

@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
    }

    public async Task<bool> HandleQueryParams()
    {
        var optionUpdated = false;

        await InvokeAsync(() =>
        {
            this.StateHasChanged();
        });

        try
        {

        }
        catch(Exception ex)
        {
            
        }

        await InvokeAsync(() => { 
            this.StateHasChanged(); 
        });

        return optionUpdated;
    }

    public async void NavigateToDailyCutscene()
    {
        try
        {
            var dateCode = DateTime.Now.ToString("yyyyMMdd");
            var sceneId = this.context.DailyCutscenes.FirstOrDefault(cutscene => cutscene.DateCode == dateCode).SceneId;
            var scene = this.context.Scenes.AsNoTracking()
                .Include(s => s.Characters).Include(s => s.Areas).Include(s => s.Game).Include(s => s.Music).Include(s => s.Worlds)
                .FirstOrDefault(s => s.Id == sceneId);

            var dailyLink = $"{NavigationManager.BaseUri}?";

            dailyLink += string.Join("&", scene.Characters.Select(x => $"character={x.Id}")) + "&";
            dailyLink += string.Join("&", scene.Areas.Select(x => $"area={x.Id}")) + "&";
            dailyLink += $"game={scene.Game.Id}&";
            dailyLink += string.Join("&", scene.Music.Select(x => $"music={x.Id}")) + "&";
            dailyLink += $"scene={scene.Id}&";
            dailyLink += string.Join("&", scene.Worlds.Select(x => $"world={x.Id}")) + "&";
            dailyLink += $"open_row={scene.Id}";

            NavigationManager.NavigateTo(dailyLink, true);
        }
        catch (Exception ex)
        {
            
        }
    }

    public async void NavigateToRandomCutscene()
    {
        try
        {
            Random random = new Random((int)DateTime.Now.Ticks);
            var randomSceneId = random.Next(0, this.context.Scenes.Count());
            var scene = this.context.Scenes.AsNoTracking()
                .Include(s => s.Characters).Include(s => s.Areas).Include(s => s.Game).Include(s => s.Music).Include(s => s.Worlds)
                .FirstOrDefault(s => s.Id == randomSceneId);

            var randomLink = $"{NavigationManager.BaseUri}?";

            randomLink += string.Join("&", scene.Characters.Select(x => $"character={x.Id}")) + "&";
            randomLink += string.Join("&", scene.Areas.Select(x => $"area={x.Id}")) + "&";
            randomLink += $"game={scene.Game.Id}&";
            randomLink += string.Join("&", scene.Music.Select(x => $"music={x.Id}")) + "&";
            randomLink += $"scene={scene.Id}&";
            randomLink += string.Join("&", scene.Worlds.Select(x => $"world={x.Id}")) + "&";
            randomLink += $"open_row={scene.Id}";

            NavigationManager.NavigateTo(randomLink, true);
        }
        catch (Exception ex)
        {
            
        }
    }
}